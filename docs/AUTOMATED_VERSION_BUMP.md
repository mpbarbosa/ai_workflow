# Automated Version Bump Feature

## Overview

The AI Workflow now includes automated semantic version bumping for target projects. This feature intelligently detects your project type, analyzes changes, and bumps the version according to semantic versioning rules.

## Quick Start

### Basic Usage

```bash
# Navigate to your project
cd /path/to/your/project

# Run version bump (auto-detect bump type)
/path/to/ai_workflow/src/workflow/bump_project_version.sh --auto-commit

# Or set TARGET_PROJECT_ROOT environment variable
export TARGET_PROJECT_ROOT=/home/mpb/Documents/GitHub/guia_turistico
/path/to/ai_workflow/src/workflow/bump_project_version.sh --auto-commit
```

### Within Workflow

The version bump is automatically performed in **Step 15** of the workflow when changes are detected:

```bash
cd /path/to/ai_workflow
./src/workflow/execute_tests_docs_workflow.sh --target /path/to/project
```

## Features

### Intelligent Bump Type Detection

The system uses multiple strategies to determine the appropriate version bump:

1. **AI Analysis** (when GitHub Copilot CLI is available):
   - Analyzes git statistics
   - Reviews changed files
   - Examines commit messages
   - Provides intelligent recommendation

2. **Heuristic Analysis** (fallback):
   - Checks conventional commit messages (feat:, fix:, BREAKING:)
   - Analyzes change size (insertions/deletions)
   - Counts modified files
   - Applies semantic versioning rules

3. **Manual Override**:
   ```bash
   ./bump_project_version.sh --type minor --auto-commit
   ```

### Supported Project Types

| Type | Detection | Tool Used |
|------|-----------|-----------|
| **Node.js** | `package.json` | npm or yarn |
| **Python** | `pyproject.toml` | poetry |
| **Python (legacy)** | `setup.py` | manual |
| **Rust** | `Cargo.toml` | cargo (manual) |
| **Go** | `go.mod` | N/A (no version in go.mod) |
| **Generic** | `.workflow-config.yaml` | manual |

### Prerelease Support

Automatically preserves and manages prerelease identifiers:

```bash
# Current: 0.7.1-alpha
# After patch bump: 0.7.2-alpha

# Explicit prerelease identifier
./bump_project_version.sh --type minor --prerelease beta
# Result: 0.8.0-beta
```

## Command-Line Options

### Standalone Script

```bash
./bump_project_version.sh [options]

Options:
  --type TYPE        Bump type: major|minor|patch|auto (default: auto)
  --target DIR       Target project directory
  --prerelease ID    Prerelease identifier (e.g., alpha, beta, rc)
  --auto-commit      Automatically commit version bump
  --yes              Skip confirmations (non-interactive)
  --help             Show help message
```

### Examples

```bash
# Auto-detect everything
./bump_project_version.sh --auto-commit --yes

# Specific bump with prerelease
./bump_project_version.sh \
  --type minor \
  --prerelease alpha \
  --target ~/projects/my-app \
  --auto-commit

# Interactive mode (default)
./bump_project_version.sh --type patch
```

## Integration with Workflow

### Step 15: Version Update

Step 15 automatically handles version bumping during workflow execution:

**When it runs:**
- After Steps 10, 12, 13, 14 (all analysis steps)
- Before Step 11 (Git Finalization)

**What it does:**
1. Detects current project version
2. Analyzes changes (AI or heuristic)
3. Determines bump type
4. Updates version in metadata files
5. Updates version in modified source files
6. Generates detailed report

**Enable/Disable:**
```bash
# Enable (default)
./execute_tests_docs_workflow.sh --target /path/to/project

# Skip specific steps (exclude 15)
./execute_tests_docs_workflow.sh --steps 0,1,2,3,4,5,6,7,8,9,10,11
```

## Version Bump Rules

### Semantic Versioning

Following [semver.org](https://semver.org/):

| Bump Type | Pattern | Use Case |
|-----------|---------|----------|
| **MAJOR** | X.0.0 | Breaking changes, removed features, incompatible API |
| **MINOR** | X.Y.0 | New features, enhancements, backward-compatible |
| **PATCH** | X.Y.Z | Bug fixes, documentation, refactoring |

### Heuristic Rules

When AI is unavailable, these heuristics apply:

```
MAJOR if:
  - Commit message contains "BREAKING CHANGE" or "breaking:"
  - More than 500 deletions
  - More than 20 files modified

MINOR if:
  - Commit message contains "feat:" or "feature:"
  - More than 100 insertions

PATCH:
  - All other cases (fixes, docs, tests, refactoring)
```

### Conventional Commits

The system recognizes [conventional commits](https://www.conventionalcommits.org/):

- `feat:` or `feature:` → **minor**
- `fix:` or `bugfix:` → **patch**
- `BREAKING CHANGE:` or `breaking:` → **major**
- `docs:`, `test:`, `refactor:`, `chore:` → **patch**

## Files Updated

The version bump updates these files (when present):

- ✅ `package.json` (Node.js)
- ✅ `package-lock.json` (auto-generated by npm)
- ✅ `pyproject.toml` (Python/Poetry)
- ✅ `setup.py` (Python legacy)
- ✅ `Cargo.toml` (Rust)
- ✅ `Cargo.lock` (auto-updated by cargo)
- ✅ `.workflow-config.yaml` (AI Workflow)

## Auto-Commit

When `--auto-commit` is enabled:

```bash
./bump_project_version.sh --auto-commit
```

The script will:
1. Stage all version files
2. Create commit: `chore: bump version to X.Y.Z`
3. Use `--no-verify` to skip pre-commit hooks

**Commit format:**
```
chore: bump version to 0.8.0-alpha
```

## Library API

For integration into custom scripts:

```bash
#!/usr/bin/env bash
source /path/to/ai_workflow/src/workflow/lib/version_bump.sh

# Get current version
current_version=$(get_current_version ".")

# Calculate new version
new_version=$(calculate_new_version "$current_version" "minor" "alpha")

# Perform automated bump
automated_version_bump "patch" "." "true" "beta"

# Manual commit
commit_version_bump "$new_version" "."
```

### Available Functions

- `detect_version_tool` - Detect package manager (npm/yarn/poetry/etc)
- `get_current_version` - Extract current version from project
- `calculate_new_version` - Calculate new version (major/minor/patch)
- `bump_version_with_tool` - Bump using detected tool
- `automated_version_bump` - Complete bump workflow
- `commit_version_bump` - Git commit version changes
- `determine_bump_type_from_git` - Heuristic bump type detection

## Troubleshooting

### "Could not detect current version"

**Cause:** No supported version file found

**Solution:**
1. Ensure your project has one of: `package.json`, `pyproject.toml`, `Cargo.toml`, or `.workflow-config.yaml`
2. Add version field:
   ```yaml
   # .workflow-config.yaml
   project:
     version: "1.0.0"
   ```

### "Version bump failed"

**Cause:** Tool not available (npm, poetry, cargo)

**Solution:**
1. Install the appropriate tool for your project type
2. Or use manual mode (will work with any project type)

### Version not preserved in git

**Cause:** `--auto-commit` not used

**Solution:**
```bash
# Manually commit after bump
git add package.json
git commit -m "chore: bump version to $(jq -r .version package.json)"
```

## Best Practices

### 1. Always Use Auto-Commit in CI/CD

```bash
./bump_project_version.sh --auto-commit --yes
```

### 2. Review Changes in Interactive Mode

```bash
# Default interactive mode shows changes before committing
./bump_project_version.sh
```

### 3. Preserve Prerelease Identifiers

The system automatically preserves existing prerelease identifiers:
```
Current: 0.7.1-alpha
Bump patch → 0.7.2-alpha  ✅ (alpha preserved)
```

### 4. Use Conventional Commits

Write commits that clearly indicate the change type:
```bash
git commit -m "feat: add new authentication module"  # → minor
git commit -m "fix: resolve login bug"               # → patch
git commit -m "feat!: change API structure"          # → major
```

### 5. Update CHANGELOG

After version bump, update your CHANGELOG.md:
```markdown
## [0.8.0-alpha] - 2026-01-27

### Added
- New feature X

### Fixed
- Bug Y
```

## Related Documentation

- [Step 15 Implementation](../steps/step_15_version_update.sh)
- [Version Bump Library](../lib/version_bump.sh)
- [Semantic Versioning](https://semver.org/)
- [Conventional Commits](https://www.conventionalcommits.org/)

## Version History

- **v1.0.0** (2026-01-27): Initial release
  - Automated version bumping
  - AI-powered bump type detection
  - Support for npm, yarn, poetry, cargo
  - Prerelease identifier preservation
  - Auto-commit functionality
